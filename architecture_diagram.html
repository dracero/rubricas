<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RubricAI Architecture Diagram</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #333;
        }
        .mermaid {
            width: 100%;
            max-width: 1200px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>RubricAI Architecture</h1>
    <div class="mermaid">
graph TD
    %% Actors
    User(Usuario)
    
    %% Frontend
    subgraph Frontend ["Interfaz de Chat (React)"]
        UI[Chat UI]
        ActionHandler[Manejador de Acciones]
    end

    %% Backend / Orchestration Layer
    subgraph Backend ["Servidor FastAPI"]
        subgraph API_Layer ["Capa de API"]
            API_Chat["/api/chat"]
            API_Gen["/api/invocaciones_especificas (upload/generate/evaluate)"]
        end
        
        subgraph Orchestrator [AgentOrchestrator]
            OrchLogic["Lógica de Enrutamiento (Gemini 2.5)"]
            Registry[Registro de Agentes]
        end
        
        %% Agents
        subgraph SocialAgents ["Agentes Sociales"]
            Greeter["GreetingAgent (LangChain)"]
        end
        
        subgraph GeneratorSystem ["Sistema Generador"]
            Ontologo[Agente Ontólogo]
            Rubricador[Agente Rubricador]
            QdrantGen[("Qdrant DB")]
        end
        
        subgraph EvaluatorSystem ["Sistema Evaluador"]
            Contexto[Agente Contexto]
            Auditor[Agente Auditor]
            Documento[Agente Documento]
        end
    end

    %% Protocol Definitions
    classDef protocol fill:#f9f,stroke:#333,stroke-width:2px;
    classDef user fill:#fff,stroke:#333,stroke-width:2px;
    
    %% Flows
    User -->|Envía Mensaje| UI
    UI -->|"POST /api/chat (ChatRequest)"| API_Chat
    API_Chat --> OrchLogic
    
    OrchLogic -->|Consulta| Registry
    
    %% Decisions
    OrchLogic -->|"Intent: Saludo"| Greeter
    Greeter -->|"Respuesta Texto"| OrchLogic
    
    OrchLogic -- "Intent: Generar" --> ActionGen["Action: show_component (RubricGenerator)"]
    OrchLogic -- "Intent: Evaluar" --> ActionEval["Action: show_component (RubricEvaluator)"]
    
    %% Responses back to UI
    ActionGen -->|"JSON (Protocolo A2UI)"| UI
    ActionEval -->|"JSON (Protocolo A2UI)"| UI
    OrchLogic -->|"JSON (Texto/Error)"| UI
    
    %% Action Handling in UI
    UI -->|Renderiza| ActionHandler
    ActionHandler -.->|"Muestra Componente"| GeneratorComp["Rubric Generator UI"]
    ActionHandler -.->|"Muestra Componente"| EvaluatorComp["Rubric Evaluator UI"]

    %% Specialized Flows (Triggered by UI Components)
    GeneratorComp -->|Requests| API_Gen
    EvaluatorComp -->|Requests| API_Gen
    
    API_Gen -->|"Llamada Directa a Agente (A2A Backend)"| GeneratorSystem
    API_Gen -->|"Llamada Directa a Agente (A2A Backend)"| EvaluatorSystem
    
    Ontologo <--> QdrantGen
    Rubricador <--> QdrantGen
    
    Contexto --> QdrantGen
    Auditor --> Contexto
    Auditor --> Documento

    %% Styling
    class User user;
    </div>
</body>
</html>
